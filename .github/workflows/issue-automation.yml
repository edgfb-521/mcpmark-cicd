name: Issue Management Automation

on:
  issues:
    types: [opened]

jobs:
  label-creator:
    runs-on: ubuntu-latest
    steps:
      - name: Create Labels
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const labels = [
              {name: 'bug', color: 'd73a4a', description: 'Something isn''t working'},
              {name: 'enhancement', color: 'a2eeef', description: 'New feature or request'},
              {name: 'epic', color: '3E4B9C' , description: 'Large feature requiring multiple sub-tasks'},
              {name: 'maintenance', color: 'fbca04', description: 'Maintenance and housekeeping tasks'},
              {name: 'priority-critical', color: 'b60205', description: 'Critical priority issue'},
              {name: 'priority-high', color: 'd93f0b', description: 'High priority issue'},
              {name: 'priority-medium', color: 'fbca04', description: 'Medium priority issue'},
              {name: 'priority-low', color: '0e8a16', description: 'Low priority issue'},
              {name: 'needs-triage', color: 'fef2c0', description: 'Needs to be reviewed by maintainers'},
              {name: 'needs-review', color: '1d76db', description: 'Awaiting review from maintainers'},
              {name: 'first-time-contributor', color: 'c2e0c6', description: 'Issue created by first-time contributor'},
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner,
                  repo,
                  name: label.name
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner,
                    repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                }
              }
            }
  issue-triage:
    needs: label-creator
    runs-on: ubuntu-latest
    outputs:
      labels: ${{ steps.triage.outputs.labels }}
    steps:
      - name: Triage Issue
        id: triage
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const title = context.payload.issue.title.toLowerCase();
            const body = context.payload.issue.body.toLowerCase();
            const labelsToAdd = ['needs-triage'];

            // Category labels
            if (title.includes('bug')) {
              labelsToAdd.push('bug');
            } else if (title.includes('epic')) {
              labelsToAdd.push('epic');
            } else if (title.includes('maintenance')) {
              labelsToAdd.push('maintenance');
            }

            // Priority labels
            const content = title + ' ' + body;
            if (content.includes('critical') || content.includes('urgent') || content.includes('production') || content.includes('outage')) {
              labelsToAdd.push('priority-critical');
            } else if (content.includes('important') || content.includes('high') || content.includes('blocking')) {
              labelsToAdd.push('priority-high');
            } else if (content.includes('medium') || content.includes('normal')) {
              labelsToAdd.push('priority-medium');
            } else if (content.includes('low') || content.includes('nice-to-have') || content.includes('minor')) {
              labelsToAdd.push('priority-low');
            } else {
              labelsToAdd.push('priority-medium');
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: labelsToAdd,
            });
            core.setOutput('labels', labelsToAdd.join(','));

  task-breakdown:
    needs: issue-triage
    if: "contains(needs.issue-triage.outputs.labels, 'epic')"
    runs-on: ubuntu-latest
    steps:
      - name: Create Sub-tasks for Epic
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;
            const parent_issue_number = issue.number;
            const parent_title = issue.title;

            const subtasks = [
              "Requirements Analysis",
              "Design and Architecture",
              "Implementation",
              "Testing and Documentation"
            ];

            const subtask_issues = [];

            for (let i = 0; i < subtasks.length; i++) {
              const task_name = subtasks[i];
              const subtask_title = `[SUBTASK] ${parent_title} - Task ${i + 1}: ${task_name}`;
              
              const new_issue = await github.rest.issues.create({
                owner,
                repo,
                title: subtask_title,
                body: `Related to #${parent_issue_number}`,
                labels: ['enhancement', 'needs-review']
              });
              subtask_issues.push(new_issue.data);
            }

            let checklist = "## Epic Tasks\n\n";
            for (const subtask of subtask_issues) {
              checklist += `- [ ] #${subtask.number}\n`;
            }

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: parent_issue_number,
              body: issue.body + "\n\n" + checklist
            });

  auto-response:
    needs: [issue-triage, task-breakdown]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Handle Auto-response and Status Change
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const author = context.payload.issue.user.login;
            
            const { data: issue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number
            });
            const labels = issue.labels.map(label => label.name);

            // 1. First-time contributor check
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              creator: author,
              state: 'all'
            });

            if (issues.length <= 3) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: ['first-time-contributor']
              });
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `Welcome @${author}! Thanks for your first contribution to this project. We'll get back to you shortly.`
              });
            }

            // 2. Post response based on issue type
            let comment_body = "";
            if (labels.includes('bug')) {
              comment_body = "Thanks for the bug report! Please review our Bug Report Guidelines to ensure all necessary information is included.";
            } else if (labels.includes('epic')) {
              comment_body = "This epic has been received. Please follow our Feature Request Process for updates.";
            } else if (labels.includes('maintenance')) {
              comment_body = "Thanks for reporting this maintenance task. Please see our Maintenance Guidelines for more information.";
            }
            
            if (comment_body) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: comment_body
              });
            }

            // 3. Set milestone for high/critical priority issues
            if (labels.includes('priority-high') || labels.includes('priority-critical')) {
                const { data: milestones } = await github.rest.issues.listMilestones({
                    owner,
                    repo,
                    state: 'open'
                });
                let milestone = milestones.find(m => m.title === 'v1.0.0');
                if (!milestone) {
                    milestone = (await github.rest.issues.createMilestone({
                        owner,
                        repo,
                        title: 'v1.0.0'
                    })).data;
                }

                await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number,
                    milestone: milestone.number
                });
            }

            // 4. Change status from 'needs-triage' to 'needs-review'
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number,
                name: 'needs-triage'
              });
            } catch (error) {
              // ignore if label doesn't exist
            }
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ['needs-review']
            });